<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Habañero Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
    <link href="/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="/css/habanero.css" rel="stylesheet" media="screen">
</head>
<body>
<div class="container">
    <div class="page-header">
        <h1>Habañero Dashboard</h1>
    </div>

    <div class="dropdown">
        <a class="dropdown-toggle" id="dLabel" role="button" data-toggle="dropdown" data-target="#">
            Actions <b class="caret"></b> </a>
        <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
            <li><a href="#startPoll">Start Polling</a></li>
            <li><a href="#stopPoll">Pause Polling</a></li>
            <li class="divider"></li>
            <li><a href="#start">Start Test Run</a></li>
            <li><a href="#stop">Stop Test Run</a></li>
        </ul>
    </div>

    <div id="response-time-percentiles"></div>
    <div id="queries-per-second"></div>
    <div id="true-queries-per-second"></div>
    <div id="brute-force-queries-per-second"></div>
    <div id="true-queries-per-minute"></div>

    <div id="history-container"></div>
</div>
</body>

<script id="history" type="text/x-handlebars-template">
    <h2>History</h2>
    <table class="table table-condensed table-hover">
        <thead>
        <tr>
            <th>Date</th>
            <th>Duration</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody>
        {{#each history}}
        <tr>
            <td>{{dateFormat date}}</td>
            <td>{{duration}} seconds</td>
            <td>
                <a href="#load/{{date}}">load</a>
            </td>
        </tr>
        {{/each}}
        </tbody>
    </table>
</script>

<script src="/js/jquery-1.10.2.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/handlebars.js"></script>
<script src="/js/highcharts.js"></script>
<script src="/js/highcharts-more.js"></script>

<script type="text/javascript">
    var Habanero = Habanero || {};
    $.extend(Habanero, {
        onDataUpdate: function (data) {
            Habanero.charts = Habanero.charts || [];
            $.each(Habanero.charts, function () {
                $.each(this.series, function () {
                    var series = this;
                    $.each(data.map(this.options.mapper, this), function () {
                        series.addPoint(this, false);
                    });
                });
                this.redraw();
            });
        },

        clear: function () {
            Habanero.charts = Habanero.charts || [];
            $.each(Habanero.charts, function () {
                $.each(this.series, function () {
                    this.setData([]);
                });
            });
        },

        poll: function () {
            $.getJSON('/api/poll').done(function (data) {
                Habanero.onDataUpdate([data]);
            });
        },

        load: function (id) {
            Habanero.stopPoll();
            Habanero.clear();
            $.getJSON("/api/load?id=" + id).done(function (data) {
                Habanero.onDataUpdate(Habanero.sortRaw(data));
            });
        },

        round: function (n, d) {
            return Math.round(n * Math.pow(10.0, 2)) / Math.pow(10.0, d);
        },

        getTime: function (d) {
            return parseInt(d['timestamp']) * 1000;
        },

        sortRaw: function (data) {
            return data.sort(function (a, b) {
                return Habanero.getTime(a) - Habanero.getTime(b);
            })
        },

        startRun: function () {
            Habanero.clear();
            Habanero.startPoll();
            $.get('/api/start');
        },

        stopRun: function () {
            $.get('/api/stop');
        },

        startPoll: function () {
            Habanero.pollIntervalId = setInterval(Habanero.poll, 1000);
        },

        stopPoll: function () {
            if (Habanero.pollIntervalId)
                clearInterval(Habanero.pollIntervalId)
        },

        route: function () {
            var hash = window.location.hash
            if (hash.length > 0) {
                var pathTokens = hash.substring(1).split("/");
                $.each(Habanero.routes, function (i, route) {
                    if (route.path == pathTokens[0]) {
                        route.fun.apply(Habanero, pathTokens.slice(1));
                        return true;
                    }
                });
            }
        },

        addRoute: function (path, fun) {
            Habanero.routes = Habanero.routes || [];
            Habanero.routes.push({path: path, fun: fun});
        },

        addChart: function (chartOptions) {
            Habanero.charts = Habanero.charts || [];
            Habanero.charts.push(new Highcharts.Chart(chartOptions));
        },

        getProperty: function (property, context) {
            var properties = property.split(".");
            try {
                return properties.reduce(function (context, prop) {
                    return context[prop];
                }, context);
            } catch (e) {
                return 0;
            }
        },

        qpsMapper: function (data) {
            var qps = 0;
            try {
                var queriesPerWorkerPerSecond = Math.pow(10, 3) / Habanero.getProperty("snapshot.global_wait.arithmetic_mean", data);
                var numWorkers = Habanero.getProperty("snapshot.worker_count", data);
                qps = Habanero.round(numWorkers * queriesPerWorkerPerSecond, 2);
            }
            catch (e) {
                console.log(e)
            }

            if (isNaN(qps)) {
                qps = 0;
            } else if (!isFinite(qps)) {
                qps = 0;
            }

            return [Habanero.getTime(data), qps];
        },

        propertyMapper: function (property) {
            return function (data) {
                return [Habanero.getTime(data), Habanero.getProperty(property, data)];
            };
        },

        initialize: function () {
            Handlebars.registerHelper('dateFormat', function (context, block) {
                return new Date(parseInt(context) * 1000).toUTCString();
            });

            $.getJSON("/api/history").done(function (data) {
                var template = Handlebars.compile($("#history").html());
                $("#history-container").append(template(data));
            });

            Habanero.addRoute('load', Habanero.load);
            Habanero.addRoute('start', Habanero.startRun);
            Habanero.addRoute('stop', Habanero.stopRun);
            Habanero.addRoute('startPoll', Habanero.startPoll);
            Habanero.addRoute('stopPoll', Habanero.stopPoll);

            $(window).on("hashchange", Habanero.route);

            Habanero.route();

            Habanero.addChart({
                title: { text: "Response Time Percentiles" },
                chart: { renderTo: 'response-time-percentiles', zoomType: 'xy' },
                xAxis: { type: 'datetime', dateTimeLabelFormats: {
                    millisecond: '%H:%M:%S'
                }, showLastLabel: true },
                yAxis: [
                    { title: { text: 'Response Time' }, labels: { format: '{value} ms' }, min: 0 },
                    { title: { text: 'Workers' }, opposite: true, min: 0}
                ],
                plotOptions: {
                    area: { marker: { enabled: false } },
                    spline: { marker: { enabled: false } }
                },
                series: [
                    { name: 'Count', type: 'area', yAxis: 1, dashStyle: 'dash', fillOpacity: 0.1, data: [], mapper: Habanero.propertyMapper("snapshot.worker_count")},
                    { name: '50', type: 'spline', data: [], mapper: Habanero.propertyMapper("snapshot.global_wait.percentile.50") },
                    { name: '75', type: 'spline', data: [], mapper: Habanero.propertyMapper("snapshot.global_wait.percentile.75")},
                    { name: '90', type: 'spline', data: [], mapper: Habanero.propertyMapper("snapshot.global_wait.percentile.90")},
                    { name: '95', type: 'spline', data: [], mapper: Habanero.propertyMapper("snapshot.global_wait.percentile.95")},
                    { name: '99', type: 'spline', data: [], mapper: Habanero.propertyMapper("snapshot.global_wait.percentile.99")},
                    { name: '999', type: 'spline', data: [], mapper: Habanero.propertyMapper("snapshot.global_wait.percentile.999")}
                ]
            });

            Habanero.addChart({
                title: { text: "Queries Per Second" },
                chart: { renderTo: 'queries-per-second', zoomType: 'xy' },
                xAxis: { type: 'datetime', dateTimeLabelFormats: {
                    millisecond: '%H:%M:%S'
                }, showLastLabel: true },
                yAxis: [
                    { title: { text: 'QPS' }, min: 0 },
                    { title: { text: 'Workers' }, opposite: true, min: 0}
                ],
                plotOptions: {
                    area: { marker: { enabled: false } },
                    spline: { marker: { enabled: false } }
                },
                series: [
                    { name: 'Count', type: 'area', yAxis: 1, dashStyle: 'dash', fillOpacity: 0.1, data: [], mapper: Habanero.propertyMapper("snapshot.worker_count")},
                    { name: 'QPS', type: 'spline', data: [], mapper: Habanero.qpsMapper}
                ]
            });

            Habanero.addChart({
                title: { text: "Brute Force Queries Per Second" },
                chart: { renderTo: 'brute-force-queries-per-second', zoomType: 'xy' },
                xAxis: { type: 'datetime', dateTimeLabelFormats: {
                    millisecond: '%H:%M:%S'
                }, showLastLabel: true },
                yAxis: [
                    { title: { text: 'BFQPS' }, min: 0 },
                    { title: { text: 'Workers' }, opposite: true, min: 0}
                ],
                plotOptions: {
                    area: { marker: { enabled: false } },
                    spline: { marker: { enabled: false } }
                },
                series: [
                    { name: 'Count', type: 'area', yAxis: 1, dashStyle: 'dash', fillOpacity: 0.1, data: [], mapper: Habanero.propertyMapper("snapshot.worker_count")},
                    { name: 'BFQPS', type: 'spline', data: [], mapper: Habanero.propertyMapper("snapshot.global_brute_force_qps")}
                ]
            });

            Habanero.addChart({
                title: { text: "True Queries Per Second" },
                chart: { renderTo: 'true-queries-per-second', zoomType: 'xy' },
                xAxis: { type: 'datetime', dateTimeLabelFormats: {
                    millisecond: '%H:%M:%S'
                }, showLastLabel: true },
                yAxis: [
                    { title: { text: 'TQPS' }, min: 0 },
                    { title: { text: 'Workers' }, opposite: true, min: 0}
                ],
                plotOptions: {
                    area: { marker: { enabled: false } },
                    spline: { marker: { enabled: false } }
                },
                series: [
                    { name: 'Count', type: 'area', yAxis: 1, dashStyle: 'dash', fillOpacity: 0.1, data: [], mapper: Habanero.propertyMapper("snapshot.worker_count")},
                    { name: 'TQPS', type: 'spline', data: [], mapper: Habanero.propertyMapper("snapshot.global_qps.n")}
                ]
            });

            Habanero.addChart({
                title: { text: "True Queries Per Minute" },
                chart: { renderTo: 'true-queries-per-minute', zoomType: 'xy' },
                xAxis: { type: 'datetime', dateTimeLabelFormats: {
                    millisecond: '%H:%M:%S'
                }, showLastLabel: true },
                yAxis: [
                    { title: { text: 'TQPM' }, min: 0 },
                    { title: { text: 'Workers' }, opposite: true, min: 0}
                ],
                plotOptions: {
                    area: { marker: { enabled: false } },
                    spline: { marker: { enabled: false } }
                },
                series: [
                    { name: 'Count', type: 'area', yAxis: 1, dashStyle: 'dash', fillOpacity: 0.1, data: [], mapper: Habanero.propertyMapper("snapshot.worker_count")},
                    { name: 'TQPM', type: 'spline', data: [], mapper: Habanero.propertyMapper("snapshot.global_qpm.one")}
                ]
            });

        }
    });

    $(function () {
        Habanero.initialize();
    });
</script>
</html>